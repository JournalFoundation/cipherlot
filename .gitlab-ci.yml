# Build only on tags that look like v*
workflow:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - when: never

stages: [build]

variables:
  REGISTRY: registry.benac.dev
  IMAGE_NAME: cipherlot-node
  KANIKO_IMAGE: gcr.io/kaniko-project/executor:v1.23.0-debug
  CONTEXT_DIR: cipherlot-node
  DOCKERFILE: cipherlot-node/Dockerfile

build-image:
  stage: build
  image:
    name: $KANIKO_IMAGE
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  before_script:
    - mkdir -p /kaniko/ssl/certs
    # Prefer proper TLS: inject Centroid CA when provided; else use Kaniko's default bundle
    - |
      if [ -n "$REGISTRY_CA_B64" ]; then
        echo "$REGISTRY_CA_B64" | base64 -d > /kaniko/ssl/certs/centroid-ca.crt
        export REGISTRY_CA_FILE=/kaniko/ssl/certs/centroid-ca.crt
        echo "Using injected registry CA at $REGISTRY_CA_FILE"
      else
        export REGISTRY_CA_FILE=/kaniko/ssl/certs/ca-certificates.crt
        echo "No REGISTRY_CA_B64 provided; using Kaniko default CA bundle"
      fi
  script:
    - |
      /kaniko/executor \
        --context "$CI_PROJECT_DIR/$CONTEXT_DIR" \
        --dockerfile "$CI_PROJECT_DIR/$DOCKERFILE" \
        --destination "$REGISTRY/$IMAGE_NAME:$CI_COMMIT_TAG" \
        --destination "$REGISTRY/$IMAGE_NAME:latest" \
        --cache=true \
        --build-arg VERSION=$CI_COMMIT_TAG \
        --registry-certificate=$REGISTRY=$REGISTRY_CA_FILE